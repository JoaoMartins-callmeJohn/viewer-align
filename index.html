<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.css">
    <title>Autodesk Forge: Simple Viewer</title>
    <style type="text/css">
      body, html {
        margin: 0;
        padding: 0;
        height: 100vh;
      }
      #header > * {
        height: 2em;
        margin: 0 0.5em;
        font-size: 1em;
        font-family: ArtifaktElement;
      }
      #header .title {
        flex: 1 0 auto;
        height: auto;
      }
      .forgeViewer {
        width: 50%;
        height: calc(100vh - 2em);
        position: relative;
        float: left;
      }
    </style>
</head>

<body onload="initViewers()">
    <div id="header">
        <img class="logo" src="/logo.png" alt="Autodesk Forge">
        <span class="title">Simple Viewer</span>
    </div>
    <div id="viewersContainer">
    </div>
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.js"></script>
</body>

<script>
  var tokenurl = 'https://l15xenb90a.execute-api.us-east-1.amazonaws.com/default/GetToken';

  var viewers = [];

  var currentViewer = null;

  async function initViewers(){
      await fetch(tokenurl).then( function(response){
      return response.json();
    }).then(function(token) {

      let urns = ['dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6cmVuZGVyY29tcGFyZWpwb20vZGVzay5ydnQ', 'dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6cmVuZGVyY29tcGFyZWpwb20vZGVzay5tYXg'];

      const options = {
        env: 'AutodeskProduction',
        accessToken: token
      };

      urns.forEach((urn, i) => {
        Autodesk.Viewing.Initializer(options, () => {

          let viewerDiv = document.createElement("div");
          viewerDiv.className = "forgeViewer";
          viewerDiv.id = `viewer${i}`;
          viewerDiv.onmouseover =  (e) => {
            if(!!e.target.viewer)
              currentViewer = e.target.viewer;
          };
          document.getElementById("viewersContainer").appendChild(viewerDiv);

          const config = {};

          let viewer = new Autodesk.Viewing.Private.GuiViewer3D(viewerDiv, config);
          viewer.start();
          viewer.setTheme("light-theme");
          Autodesk.Viewing.Document.load(`urn:${urn}`, doc => {
            var viewables = doc.getRoot().getDefaultGeometry();
            viewer.loadDocumentNode(doc, viewables);
            // viewer.addEventListener(Autodesk.Viewing.CAMERA_CHANGE_EVENT, () => handleChange() );
            viewers.push(viewer);
          });
        });
      });
    });
  }

  function handleChange(){
    viewers.forEach((v, i) => {
      let options = {
        seedURN: false,
        objectSet: false,
        viewport: true,
        renderOptions: true,
        cutplanes: true
      };
      let currentViewerState = currentViewer.getState(options);
      if(v !== currentViewer)
        v.restoreState(currentViewerState);
    })
  }

</script>

</html>